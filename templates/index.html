<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Contrôle conformité PixelCRM - IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-8 space-y-6">
    <h1 class="text-2xl font-bold text-slate-800">
      Contrôle de conformité des dossiers <span class="text-indigo-600">PixelCRM</span>
    </h1>
    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 text-sm text-slate-700 space-y-1">
      <p class="font-semibold text-indigo-700">Utilisation ultra simple :</p>
      <p>1) Saisir le numéro IEN, 2) déposer les PDF (ou un dossier complet), 3) cliquer « Analyser ».</p>
      <p class="text-slate-600">L'outil pré-remplit automatiquement les infos PixelCRM, fait l'OCR, vérifie les règles métiers et classe le dossier.</p>
    </div>

    <!-- Formulaire -->
    <form id="dossierForm" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- IEN + bouton PixelCRM -->
        <div>
          <label class="block text-sm font-medium text-slate-700">N° de dossier (IEN)</label>
          <div class="flex gap-2 mt-1">
            <input
              id="fieldIen"
              type="text"
              name="ien"
              required
              class="block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="IEN-2025-XXXXX"
              autocomplete="off"
            />
            <button
              type="button"
              id="btnPixelPrefill"
              class="shrink-0 rounded-xl border border-indigo-500 px-3 py-2 text-xs font-medium text-indigo-600 hover:bg-indigo-50"
            >
              PixelCRM
            </button>
          </div>
          <p id="pixelStatus" class="mt-1 text-xs text-slate-500"></p>
        </div>

        <!-- Nom du client -->
        <div>
          <label class="block text-sm font-medium text-slate-700">Nom du client</label>
          <input
            id="fieldClientNom"
            type="text"
            name="client_nom"
            required
            class="mt-1 block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Nom du client"
          />
        </div>

        <!-- Délégataire -->
        <div>
          <label class="block text-sm font-medium text-slate-700">Délégataire</label>
          <select
            name="delegataire"
            required
            class="mt-1 block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <option value="">— Sélectionner —</option>
            {% for d in delegataires %}
              <option value="{{ d }}">{{ d }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700">N° SIRET</label>
          <input
            type="text"
            name="siret"
            class="mt-1 block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Type d'opération CEE</label>
          <input
            type="text"
            name="type_operation"
            class="mt-1 block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Prime CEE</label>
          <input
            type="text"
            name="prime_cee"
            class="mt-1 block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">N° prime CEE</label>
          <input
            type="text"
            name="numero_prime"
            class="mt-1 block w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>
      </div>

      <!-- Dropzone fichiers -->
      <div
        id="dropzone"
        class="mt-4 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-2xl px-4 py-10 bg-slate-50 cursor-pointer hover:border-indigo-400 transition"
      >
        <input
            id="fileInput"
            type="file"
            name="files"
            multiple
            webkitdirectory
            directory
            mozdirectory
            class="hidden"
            accept="application/pdf"
          />
        <p class="text-sm text-slate-600 text-center">
          Glisser-déposer ici les PDF du dossier (devis, facture, attestation...) ou
          <span class="text-indigo-600 font-medium">cliquer pour sélectionner un ou plusieurs fichiers / un dossier</span>.<br />
          <span class="text-xs text-slate-400">Les fichiers vides (0 Ko) seront ignorés automatiquement.</span>
        </p>
        <ul id="fileList" class="mt-3 text-xs text-slate-700 space-y-1"></ul>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-600">
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
          <p class="font-semibold text-slate-700">Identification automatique :</p>
          <p>Devis, Facture, AH, AFT, Bon de livraison, Cadre de contribution, avec OCR si besoin.</p>
        </div>
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
          <p class="font-semibold text-slate-700">Vérifications clés :</p>
          <p>Mentions obligatoires, dates cohérentes, montants alignés avec PixelCRM, SIRET identique, ordre logique des documents.</p>
        </div>
      </div>

      <div class="flex items-center justify-between pt-4 border-t border-slate-200">
        <button
          type="submit"
          class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 px-5 py-2.5 text-sm font-medium text-white shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          <span>Analyser le dossier</span>
          <span id="spinner" class="hidden animate-spin border-2 border-white/40 border-t-white rounded-full w-4 h-4"></span>
        </button>
        <span id="statusMessage" class="text-sm text-slate-500"></span>
      </div>
    </form>

    <!-- Zone de résultat -->
    <div id="resultPanel" class="hidden border border-slate-200 rounded-2xl p-4 bg-slate-50 space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-800">Résultat de l'analyse</h2>
        <span id="badgeStatus" class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold"></span>
      </div>
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-slate-700"><span class="font-medium">Dossier :</span> <span id="resDossier"></span></p>
          <p class="text-sm text-slate-700"><span class="font-medium">Délégataire :</span> <span id="resDelegataire"></span></p>
        </div>
        <a
          id="driveLink"
          href="#"
          target="_blank"
          class="hidden inline-flex items-center rounded-xl border border-indigo-500 px-3 py-1.5 text-xs font-medium text-indigo-600 hover:bg-indigo-50"
        >
          Ouvrir sur Google Drive
        </a>
      </div>

      <div class="space-y-3">
        <div>
          <h3 class="text-sm font-semibold text-slate-800 mb-1">Résumé (points principaux) :</h3>
          <ul id="resSummary" class="list-disc list-inside text-sm text-slate-700 space-y-1"></ul>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-slate-800 mb-1">Documents détectés :</h3>
          <ul id="resDocs" class="list-disc list-inside text-sm text-slate-700 space-y-1"></ul>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-slate-800 mb-1">Détails techniques :</h3>
          <ul id="resProblems" class="list-disc list-inside text-sm text-slate-700 space-y-1"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // --- 1) Pré-remplir depuis l'URL ---
      const params        = new URLSearchParams(window.location.search);
      const ienField      = document.querySelector('input[name="ien"]');
      const clientField   = document.querySelector('input[name="client_nom"]');
      const siretField    = document.querySelector('input[name="siret"]');
      const typeOpField   = document.querySelector('input[name="type_operation"]');
      const primeField    = document.querySelector('input[name="prime_cee"]');
      const primeNumField = document.querySelector('input[name="numero_prime"]');

      if (params.has("ien")            && ienField)      ienField.value      = params.get("ien");
      if (params.has("client_nom")     && clientField)   clientField.value   = params.get("client_nom");
      if (params.has("siret")          && siretField)    siretField.value    = params.get("siret");
      if (params.has("type_operation") && typeOpField)   typeOpField.value   = params.get("type_operation");
      if (params.has("prime_cee")      && primeField)    primeField.value    = params.get("prime_cee");
      if (params.has("numero_prime")   && primeNumField) primeNumField.value = params.get("numero_prime");

      // --- 2) Références DOM ---
      const form          = document.getElementById("dossierForm");
      const fileInput     = document.getElementById("fileInput");
      const dropzone      = document.getElementById("dropzone");
      const fileList      = document.getElementById("fileList");
      const spinner       = document.getElementById("spinner");
      const statusMessage = document.getElementById("statusMessage");
      const resultPanel   = document.getElementById("resultPanel");
      const badgeStatus   = document.getElementById("badgeStatus");
      const resDossier    = document.getElementById("resDossier");
      const resDelegataire= document.getElementById("resDelegataire");
      const resSummary    = document.getElementById("resSummary");
      const resDocs       = document.getElementById("resDocs");
      const resProblems   = document.getElementById("resProblems");
      const driveLink     = document.getElementById("driveLink");

      const fieldIen      = document.getElementById("fieldIen");
      const pixelStatus   = document.getElementById("pixelStatus");
      const btnPixelPrefill = document.getElementById("btnPixelPrefill");

      // --- 3) Pré-remplissage automatique via PixelCRM ---
      const delegSelect = document.querySelector('select[name="delegataire"]');

        let lastFetchedIen = "";
        const fetchPixelData = async () => {
          const ien = fieldIen.value.trim();

          if (!ien || ien === lastFetchedIen) {
            if (!ien) {
              pixelStatus.textContent = "Merci d'indiquer un numéro IEN avant de pré-remplir.";
              pixelStatus.className = "mt-1 text-xs text-red-500";
            }
            return;
          }

          pixelStatus.textContent = "Recherche des informations PixelCRM…";
          pixelStatus.className = "mt-1 text-xs text-slate-500";
          btnPixelPrefill.disabled = true;

          try {
            const res = await fetch(`/pixelcrm-prefill?ien=${encodeURIComponent(ien)}`);

            if (!res.ok) {
              throw new Error("Réponse serveur inattendue");
            }

            const data = await res.json();

            // Remplissage des champs texte
            if (data.client_nom !== undefined) clientField.value = data.client_nom || "";
            if (data.siret !== undefined)       siretField.value = data.siret || "";
            if (data.type_operation !== undefined) typeOpField.value = data.type_operation || "";
            if (data.prime_cee !== undefined)   primeField.value = data.prime_cee || "";
            if (data.numero_prime !== undefined)primeNumField.value = data.numero_prime || "";

            // Remplissage du délégataire
            if (delegSelect && data.delegataire) {
              const existing = Array.from(delegSelect.options).find((opt) => opt.value === data.delegataire);

              if (!existing) {
                const opt = document.createElement("option");
                opt.value = data.delegataire;
                opt.textContent = `${data.delegataire} (PixelCRM)`;
                delegSelect.appendChild(opt);
              }

              delegSelect.value = data.delegataire;
            }

            lastFetchedIen = ien;
            pixelStatus.textContent = "Champs remplis automatiquement depuis PixelCRM.";
            pixelStatus.className = "mt-1 text-xs text-emerald-600";
          } catch (error) {
            console.error(error);
            pixelStatus.textContent = "Impossible de récupérer le dossier PixelCRM (vérifier l'IEN).";
            pixelStatus.className = "mt-1 text-xs text-red-500";
          } finally {
            btnPixelPrefill.disabled = false;
          }
        };

        btnPixelPrefill.addEventListener("click", fetchPixelData);
        fieldIen.addEventListener("blur", fetchPixelData);
        fieldIen.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            fetchPixelData();
          }
        });

      // --- 4) Gestion fichiers ---
      dropzone.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", () => {
        fileList.innerHTML = "";
        const allFiles  = Array.from(fileInput.files);
        const validFiles = allFiles.filter((f) => f.size > 0);

        if (!validFiles.length && allFiles.length > 0) {
          const li = document.createElement("li");
          li.textContent = "Tous les fichiers sélectionnés sont vides (0 Ko) et ont été ignorés.";
          li.classList.add("text-red-500");
          fileList.appendChild(li);
          return;
        }

        validFiles.forEach((f) => {
          const li = document.createElement("li");
          li.textContent = `${f.name} (${Math.round(f.size / 1024)} Ko)`;
          fileList.appendChild(li);
        });
      });

      ["dragenter", "dragover"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.add("border-indigo-400", "bg-indigo-50/50");
        });
      });

      ["dragleave", "drop"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.remove("border-indigo-400", "bg-indigo-50/50");
        });
      });

      dropzone.addEventListener("drop", (e) => {
        const files = e.dataTransfer.files;
        fileInput.files = files;
        fileInput.dispatchEvent(new Event("change"));
      });

      // --- 5) Soumission formulaire ---
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusMessage.textContent = "";
        resultPanel.classList.add("hidden");

        const allFiles   = Array.from(fileInput.files);
        const validFiles = allFiles.filter((f) => f.size > 0);

        if (!validFiles.length) {
          statusMessage.textContent = "Merci d'ajouter au moins un PDF non vide.";
          statusMessage.classList.remove("text-slate-500");
          statusMessage.classList.add("text-red-500");
          return;
        }

        spinner.classList.remove("hidden");
        statusMessage.textContent = "Analyse en cours...";
        statusMessage.classList.remove("text-red-500");
        statusMessage.classList.add("text-slate-500");

        const formData = new FormData(form);
        validFiles.forEach((f) => formData.append("files", f));

        try {
          const res = await fetch("/analyze", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) throw new Error("Erreur serveur");
          const data = await res.json();

          resDossier.textContent     = data.dossier;
          resDelegataire.textContent = data.delegataire;

          resSummary.innerHTML = "";
          const mainReasons = (data.summary && data.summary.main_reasons) || [];
          mainReasons.forEach((p) => {
            const li = document.createElement("li");
            li.textContent = p;
            resSummary.appendChild(li);
          });

          resDocs.innerHTML = "";
          const docPresence = data.document_presence || [];
          docPresence.forEach((doc) => {
            const li = document.createElement("li");
            li.textContent = `${doc.present ? "✔️" : "❌"} ${doc.type}` +
              (doc.example ? ` (${doc.example})` : "");
            li.className = doc.present ? "text-emerald-700" : "text-red-600";
            resDocs.appendChild(li);
          });

          resProblems.innerHTML = "";
          (data.problems || []).forEach((p) => {
            const li = document.createElement("li");
            li.textContent = p;
            resProblems.appendChild(li);
          });

          badgeStatus.textContent =
            data.status === "conforme" ? "CONFORME" : "NON CONFORME";
          badgeStatus.className =
            "inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold " +
            (data.status === "conforme"
              ? "bg-emerald-100 text-emerald-700"
              : "bg-red-100 text-red-700");

          if (data.drive_url) {
            driveLink.href = data.drive_url;
            driveLink.classList.remove("hidden");
          } else {
            driveLink.classList.add("hidden");
          }

          resultPanel.classList.remove("hidden");
          statusMessage.textContent = "Analyse terminée.";
        } catch (err) {
          console.error(err);
          statusMessage.textContent = "Erreur pendant l'analyse.";
          statusMessage.classList.remove("text-slate-500");
          statusMessage.classList.add("text-red-500");
        } finally {
          spinner.classList.add("hidden");
        }
      });
    });
  </script>
</body>
</html>
